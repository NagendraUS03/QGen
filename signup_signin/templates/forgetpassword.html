<!DOCTYPE html>
<html lang="en" class="bg-gray-900 text-white">
<head>
  <meta charset="UTF-8">
  <title>Forgot Password</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="flex flex-col min-h-screen bg-gray-900 text-white">

  <!-- Main content takes up all available vertical space -->
  <main class="flex-1 flex items-center justify-center px-4">
    <div class="bg-gray-800 shadow-lg rounded-xl w-full max-w-md p-6 space-y-6">
      <h2 class="text-2xl font-bold text-center text-indigo-400">Reset Password</h2>

      <!-- Flash messages -->
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="p-2 rounded {% if category == 'success' %}bg-green-500{% elif category == 'danger' %}bg-red-500{% elif category == 'info' %}bg-blue-500{% else %}bg-yellow-500{% endif %} text-white text-sm">
              {{ message }}
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      <!-- Step 1: Email input -->
      <div id="email-step" {% if show_otp_form %}class="hidden"{% endif %}>
        <form method="POST" class="space-y-4" id="email-form" action="{{ url_for('main.forgot_password') }}">
          {{ form.hidden_tag() }}
          <div>
            <label class="block text-sm font-medium text-white mb-1">Email</label>
            {{ form.email(size=32, class="w-full px-3 py-2 rounded bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-400") }}
            {% if form.email.errors %}
              <div class="text-red-400 text-xs mt-1">
                {% for error in form.email.errors %}
                  <span>{{ error }}</span>
                {% endfor %}
              </div>
            {% endif %}
          </div>
          <input type="hidden" name="step" value="email">
          <div>
            <button type="submit" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white py-2 rounded-lg font-semibold">
              Send OTP
            </button>
          </div>
        </form>
      </div>

      <!-- Step 2: OTP & Password -->
      <div id="otp-step" {% if not show_otp_form %}class="hidden"{% endif %}>
        <form method="POST" class="space-y-4" id="otp-form" action="{{ url_for('main.forgot_password') }}">
          {{ form.hidden_tag() }}
          <input type="hidden" name="email" value="{{ email }}">
          <input type="hidden" name="step" value="verify">

          <div>
            <label class="block text-sm font-medium text-white mb-1">Enter OTP</label>
            {{ form.otp(size=32, class="w-full px-3 py-2 rounded bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-400") }}
            {% if form.otp.errors %}
              <div class="text-red-400 text-xs mt-1">
                {% for error in form.otp.errors %}
                  <span>{{ error }}</span>
                {% endfor %}
              </div>
            {% endif %}
            <p class="text-xs text-gray-400 mt-1">Check your email for the OTP.</p>
          </div>

          <div>
            <label class="block text-sm font-medium text-white mb-1">New Password</label>
            <div class="relative">
              {{ form.new_password(size=32, id="new-password", class="w-full px-3 py-2 pr-10 rounded bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-400") }}
              <span class="absolute right-3 top-1/2 transform -translate-y-1/2 cursor-pointer text-white" onclick="togglePassword(this)">üëÅÔ∏è</span>
              {% if form.new_password.errors %}
                <div class="text-red-400 text-xs mt-1">
                  {% for error in form.new_password.errors %}
                    <span>{{ error }}</span>
                  {% endfor %}
                </div>
              {% endif %}
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-white mb-1">Confirm New Password</label>
            <div class="relative">
              {{ form.confirm_password(size=32, id="confirm-password", class="w-full px-3 py-2 pr-10 rounded bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-400") }}
              <span class="absolute right-3 top-1/2 transform -translate-y-1/2 cursor-pointer text-white" onclick="togglePassword(this)">üëÅÔ∏è</span>
              {% if form.confirm_password.errors %}
                <div class="text-red-400 text-xs mt-1">
                  {% for error in form.confirm_password.errors %}
                    <span>{{ error }}</span>
                  {% endfor %}
                </div>
              {% endif %}
            </div>
          </div>

          <div>
            {{ form.submit(class="w-full bg-indigo-500 hover:bg-indigo-600 text-white py-2 rounded-lg font-semibold") }}
          </div>
        </form>

        <div class="mt-4">
          <form method="POST" action="{{ url_for('main.forgot_password') }}">
            {{ form.hidden_tag() }}
            <input type="hidden" name="email" value="{{ email }}">
            <input type="hidden" name="step" value="resend">
            <button type="submit" class="w-full bg-gray-600 hover:bg-gray-700 text-white py-2 rounded-lg text-sm">
              Resend OTP
            </button>
          </form>
        </div>
      </div>

      <p class="text-sm text-center text-gray-300">
        Remembered your password? 
        <a href="{{ url_for('main.login') }}" class="text-indigo-400 hover:underline">Go to Login</a>
      </p>
    </div>
  </main>

  <script>
    function togglePassword(icon) {
      const input = icon.previousElementSibling;
      if (input.type === "password") {
        input.type = "text";
        icon.textContent = "üôà";
      } else {
        input.type = "password";
        icon.textContent = "üëÅÔ∏è";
      }
    }
  </script>
</body>
</html>
