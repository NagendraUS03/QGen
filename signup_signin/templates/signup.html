<!DOCTYPE html>
<html lang="en" class="bg-gray-900 text-white">
<head>
  <meta charset="UTF-8">
  <title>Signup - QGen</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .strength-bar { transition: all 0.3s ease; }
    .feedback-msg { font-size: 0.85rem; margin-top: 0.25rem; }
  </style>
</head>
<body class="flex items-center justify-center min-h-screen px-4">
  <div class="bg-gray-800 shadow-xl rounded-xl w-full max-w-md p-6 space-y-6">
    <h2 class="text-2xl font-bold text-center text-indigo-400">Create Account</h2>

    <!-- Step 1: Email Verification Form -->
    <form id="email-form" class="space-y-4">
      <div>
        <label for="username" class="block text-sm font-medium">Username</label>
        <input type="text" id="username" name="username" required class="w-full px-3 py-2 rounded bg-gray-700 border border-gray-600">
        <p id="username-feedback" class="feedback-msg"></p>
      </div>

      <div>
        <label for="email" class="block text-sm font-medium">Email</label>
        <input type="email" id="email" name="email" required class="w-full px-3 py-2 rounded bg-gray-700 border border-gray-600">
        <p id="email-feedback" class="feedback-msg"></p>
      </div>

      <button type="button" id="send-otp-btn" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white py-2 rounded-lg">
        Send Verification Code
      </button>
    </form>

    <!-- Step 2: OTP + Password Form -->
    <form id="otp-form" class="space-y-4 hidden">
      <div>
        <label for="otp" class="block text-sm font-medium">Enter OTP</label>
        <input type="text" id="otp" name="otp" maxlength="6" required class="w-full px-3 py-2 rounded bg-gray-700 border border-gray-600">
        <p id="otp-feedback" class="feedback-msg"></p>
      </div>

      <div>
        <label for="password" class="block text-sm font-medium">Password</label>
        <input type="password" id="password" name="password" required class="w-full px-3 py-2 rounded bg-gray-700 border border-gray-600">
        <div class="h-2 bg-gray-600 rounded-full mt-2">
          <div id="strength-bar" class="h-2 rounded-full strength-bar"></div>
        </div>
      </div>

      <div>
        <label for="confirm_password" class="block text-sm font-medium">Confirm Password</label>
        <input type="password" id="confirm_password" name="confirm_password" required class="w-full px-3 py-2 rounded bg-gray-700 border border-gray-600">
      </div>

      <button type="button" id="signup-btn" class="w-full bg-green-500 hover:bg-green-600 text-white py-2 rounded-lg">
        Create Account
      </button>
    </form>

    <p class="text-sm text-center text-gray-300">Already have an account?
      <a href="/login" class="text-indigo-400 hover:underline">Login</a>
    </p>
  </div>

  <script>
    const usernameEl = document.getElementById("username");
    const emailEl = document.getElementById("email");
    const passwordEl = document.getElementById("password");
    const otpEl = document.getElementById("otp");

    usernameEl.addEventListener("input", () => {
      const username = usernameEl.value;
      const feedback = document.getElementById("username-feedback");
      const regex = /^(?=.*[A-Z])(?=.*\d)(?=.*[^A-Za-z0-9]).{3,}$/;

      if (!regex.test(username)) {
        feedback.textContent = "❌ Must have 1 uppercase, 1 number, 1 special char";
        feedback.className = "feedback-msg text-red-400";
      } else {
        fetch("/validate-username", {
          method: "POST",
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username })
        })
        .then(res => res.json())
        .then(data => {
          if (data.valid) {
            feedback.textContent = "✅ Username available";
            feedback.className = "feedback-msg text-green-400";
          } else {
            feedback.textContent = "❌ " + data.message;
            feedback.className = "feedback-msg text-red-400";
          }
        });
      }
    });

    emailEl.addEventListener("input", () => {
      const email = emailEl.value;
      const feedback = document.getElementById("email-feedback");

      fetch("/validate-email", {
        method: "POST",
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email })
      })
      .then(res => res.json())
      .then(data => {
        if (data.valid) {
          feedback.textContent = "✅ Email valid";
          feedback.className = "feedback-msg text-green-400";
        } else {
          feedback.textContent = "❌ " + data.message;
          feedback.className = "feedback-msg text-red-400";
        }
      });
    });

    passwordEl.addEventListener("input", () => {
      const value = passwordEl.value;
      const bar = document.getElementById("strength-bar");
      const score = [
        /[A-Z]/.test(value),
        /[a-z]/.test(value),
        /\d/.test(value),
        /[^A-Za-z0-9]/.test(value),
        value.length >= 8
      ].filter(Boolean).length;

      bar.style.width = `${score * 20}%`;
      bar.style.backgroundColor = ["#f87171", "#facc15", "#60a5fa", "#34d399", "#22c55e"][score - 1] || "#f87171";
    });

    otpEl.addEventListener("input", () => {
      const otp = otpEl.value;
      const feedback = document.getElementById("otp-feedback");

      if (otp.length === 6) {
        fetch("/verify-otp", {
          method: "POST",
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ otp })
        })
        .then(res => res.json())
        .then(data => {
          if (data.valid) {
            feedback.textContent = "✅ OTP verified";
            feedback.className = "feedback-msg text-green-400";
          } else {
            feedback.textContent = "❌ Invalid OTP";
            feedback.className = "feedback-msg text-red-400";
          }
        });
      } else {
        feedback.textContent = "";
      }
    });

    document.getElementById("send-otp-btn").addEventListener("click", () => {
      const email = emailEl.value;
      const username = usernameEl.value;

      fetch("/signup", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({ step: "1", email, username })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          document.getElementById("email-form").classList.add("hidden");
          document.getElementById("otp-form").classList.remove("hidden");
          alert("✅ OTP sent successfully!");
        } else {
          alert("❌ " + (data.errors?.[0] || "Unknown error"));
        }
      });
    });

    document.getElementById("signup-btn").addEventListener("click", () => {
      const otp = otpEl.value;
      const password = passwordEl.value;
      const confirm_password = document.getElementById("confirm_password").value;

      fetch("/signup", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({ step: "2", otp, password, confirm_password })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert("✅ Account created! Check your email.");
          window.location.href = "/login";
        } else {
          alert("❌ " + (data.errors?.[0] || "Unknown error"));
        }
      });
    });
  </script>
</body>
</html>
